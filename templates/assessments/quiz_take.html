<!-- templates/assessments/quiz_take.html -->

{% extends 'base.html' %}

{% block title %}{{ quiz.title }} - Test{% endblock %}

{% block extra_css %}
<style>
    .question-card {
        border-left: 4px solid #0d6efd;
    }
    .form-check {
        padding: 10px 10px 10px 40px;
        margin-bottom: 5px;
        border-radius: 5px;
        transition: background-color 0.2s;
    }
    .form-check:hover {
        background-color: #f8f9fa;
    }
    .timer-fixed {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1000;
    }
    .timer-warning {
        animation: pulse 1s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1">{{ quiz.title }}</h4>
        <span class="text-muted">{{ quiz.course.name }}</span>
    </div>
</div>

<!-- Timer -->
{% if time_remaining is not None %}
    <div class="timer-fixed">
        <div class="card shadow" id="timer-card">
            <div class="card-body text-center py-2 px-3">
                <small class="text-muted d-block">Qolgan vaqt</small>
                <h4 class="mb-0" id="timer">--:--</h4>
            </div>
        </div>
    </div>
{% endif %}

<form method="post" id="quiz-form">
    {% csrf_token %}

    {% for question in questions %}
        <div class="card shadow-sm mb-4 question-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <strong>Savol {{ forloop.counter }}</strong>
                    <span class="badge bg-secondary ms-2">{{ question.points }} ball</span>
                </span>
                <span class="badge bg-info">{{ question.get_question_type_display }}</span>
            </div>
            <div class="card-body">
                <p class="mb-4">{{ question.text }}</p>

                {% if question.question_type == 'single' or question.question_type == 'true_false' %}
                    {% for answer in question.answers.all %}
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="radio"
                                   name="question_{{ question.pk }}"
                                   id="answer_{{ answer.pk }}"
                                   value="{{ answer.pk }}"
                                   required>
                            <label class="form-check-label w-100" for="answer_{{ answer.pk }}">
                                {{ answer.text }}
                            </label>
                        </div>
                    {% endfor %}
                {% elif question.question_type == 'multiple' %}
                    {% for answer in question.answers.all %}
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   name="question_{{ question.pk }}"
                                   id="answer_{{ answer.pk }}"
                                   value="{{ answer.pk }}">
                            <label class="form-check-label w-100" for="answer_{{ answer.pk }}">
                                {{ answer.text }}
                            </label>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    {% endfor %}

    <div class="card shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted">Jami: {{ questions|length }} ta savol</span>
            </div>
            <div>
                <button type="submit" class="btn btn-success btn-lg" onclick="return confirm('Testni yakunlashni xohlaysizmi?')">
                    <i class="bi bi-check-lg me-2"></i>Yakunlash
                </button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
{% if time_remaining is not None %}
<script>
    let timeRemaining = {{ time_remaining }};
    const timerElement = document.getElementById('timer');
    const timerCard = document.getElementById('timer-card');
    const quizForm = document.getElementById('quiz-form');

    function updateTimer() {
        if (timeRemaining <= 0) {
            timerElement.textContent = "00:00";
            alert("Vaqt tugadi! Test avtomatik yuborilmoqda...");
            quizForm.submit();
            return;
        }

        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerElement.textContent =
            String(minutes).padStart(2, '0') + ':' +
            String(seconds).padStart(2, '0');

        // Ogohlantirish (5 daqiqa qolganda)
        if (timeRemaining <= 300) {
            timerCard.classList.add('bg-danger', 'text-white');
            timerCard.classList.add('timer-warning');
        } else if (timeRemaining <= 600) {
            timerCard.classList.add('bg-warning');
        }

        timeRemaining--;
    }

    updateTimer();
    setInterval(updateTimer, 1000);

    // Sahifadan chiqishda ogohlantirish
    window.onbeforeunload = function() {
        return "Test yakunlanmagan. Rostdan ham chiqmoqchimisiz?";
    };

    // Form yuborilganda ogohlantirishni o'chirish
    quizForm.onsubmit = function() {
        window.onbeforeunload = null;
    };
</script>
{% endif %}
{% endblock %}